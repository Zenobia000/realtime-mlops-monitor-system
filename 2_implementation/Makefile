# Model API ç›£æ§ç³»çµ± Makefile
# ç°¡åŒ–é–‹ç™¼æµç¨‹å’Œç’°å¢ƒç®¡ç†

.PHONY: help install setup test lint format run clean dev docs

# é è¨­ç›®æ¨™
help:
	@echo "ğŸš€ Model API ç›£æ§ç³»çµ±é–‹ç™¼æŒ‡ä»¤"
	@echo ""
	@echo "ğŸ“¦ ç’°å¢ƒç®¡ç†:"
	@echo "  make install     - å®‰è£ Poetry ä¸¦è¨­ç½® Python 3.10 ç’°å¢ƒ"
	@echo "  make setup       - å®Œæ•´é …ç›®è¨­ç½® (ç’°å¢ƒ + ä¾è³´ + .env)"
	@echo "  make env         - ç”Ÿæˆ .env ç’°å¢ƒé…ç½®æ–‡ä»¶"
	@echo ""
	@echo "ğŸƒ é–‹ç™¼æœå‹™:"
	@echo "  make dev         - å•Ÿå‹•é–‹ç™¼æœå‹™å™¨ (ç†±é‡è¼‰)"
	@echo "  make run         - å•Ÿå‹•ç”Ÿç”¢æ¨¡å¼æœå‹™å™¨"
	@echo "  make test-api    - å¿«é€Ÿæ¸¬è©¦ API åŠŸèƒ½"
	@echo ""
	@echo "ğŸ” ç¨‹å¼ç¢¼å“è³ª:"
	@echo "  make test        - é‹è¡Œæ‰€æœ‰æ¸¬è©¦"
	@echo "  make lint        - ç¨‹å¼ç¢¼æª¢æŸ¥ (flake8 + mypy)"
	@echo "  make format      - ç¨‹å¼ç¢¼æ ¼å¼åŒ– (black + isort)"
	@echo "  make check       - å®Œæ•´å“è³ªæª¢æŸ¥ (lint + test)"
	@echo ""
	@echo "ğŸ“š æ–‡æª”èˆ‡æ¸…ç†:"
	@echo "  make docs        - ç”ŸæˆAPIæ–‡æª”"
	@echo "  make clean       - æ¸…ç†è‡¨æ™‚æ–‡ä»¶"
	@echo "  make status      - æª¢æŸ¥æœå‹™ç‹€æ…‹"

# æª¢æŸ¥ Poetry æ˜¯å¦å·²å®‰è£
check-poetry:
	@which poetry > /dev/null || (echo "âŒ Poetry æœªå®‰è£ï¼è«‹å…ˆå®‰è£ Poetry: curl -sSL https://install.python-poetry.org | python3 -" && exit 1)
	@echo "âœ… Poetry å·²å®‰è£"

# å®‰è£ Poetry ç’°å¢ƒ
install: check-poetry
	@echo "ğŸ“¦ è¨­ç½® Poetry ç’°å¢ƒ (Python 3.10)..."
	poetry env use python3.10
	poetry install
	@echo "âœ… Poetry ç’°å¢ƒè¨­ç½®å®Œæˆ"

# å®Œæ•´é …ç›®è¨­ç½®
setup: install env
	@echo "ğŸ¯ å®Œæ•´é …ç›®è¨­ç½®å®Œæˆï¼"
	@echo "ğŸ’¡ ä¸‹ä¸€æ­¥ï¼š"
	@echo "   make dev    # å•Ÿå‹•é–‹ç™¼æœå‹™å™¨"
	@echo "   make test   # é‹è¡Œæ¸¬è©¦"

# ç”Ÿæˆç’°å¢ƒé…ç½®
env:
	@echo "ğŸ”§ ç”Ÿæˆç’°å¢ƒé…ç½®æ–‡ä»¶..."
	poetry run python setup_env.py
	@echo "âœ… ç’°å¢ƒé…ç½®å®Œæˆ"

# é–‹ç™¼æœå‹™å™¨ (ç†±é‡è¼‰)
dev: check-poetry
	@echo "ğŸš€ å•Ÿå‹•é–‹ç™¼æœå‹™å™¨..."
	poetry run uvicorn src.api.main:app --host 0.0.0.0 --port 8001 --reload

# ç”Ÿç”¢æ¨¡å¼æœå‹™å™¨
run: check-poetry
	@echo "ğŸƒ å•Ÿå‹•ç”Ÿç”¢æ¨¡å¼æœå‹™å™¨..."
	poetry run uvicorn src.api.main:app --host 0.0.0.0 --port 8001 --workers 4

# å¿«é€Ÿ API æ¸¬è©¦
test-api:
	@echo "ğŸ” å¿«é€Ÿæ¸¬è©¦ API..."
	@echo "å¥åº·æª¢æŸ¥:"
	@curl -s http://localhost:8001/health | python3 -m json.tool || echo "âŒ API æœªå•Ÿå‹•"
	@echo ""
	@echo "API è³‡è¨Š:"
	@curl -s http://localhost:8001/v1 | python3 -m json.tool || echo "âŒ API æœªå•Ÿå‹•"

# é‹è¡Œæ¸¬è©¦
test: check-poetry
	@echo "ğŸ§ª é‹è¡Œæ¸¬è©¦..."
	poetry run pytest -v --cov=src --cov-report=term-missing

# ç¨‹å¼ç¢¼æª¢æŸ¥
lint: check-poetry
	@echo "ğŸ” ç¨‹å¼ç¢¼æª¢æŸ¥..."
	poetry run flake8 src/ --max-line-length=88 --extend-ignore=E203,W503
	poetry run mypy src/

# ç¨‹å¼ç¢¼æ ¼å¼åŒ–
format: check-poetry
	@echo "ğŸ¨ ç¨‹å¼ç¢¼æ ¼å¼åŒ–..."
	poetry run black src/
	poetry run isort src/

# å®Œæ•´å“è³ªæª¢æŸ¥
check: format lint test
	@echo "âœ… ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥å®Œæˆ"

# ç”Ÿæˆæ–‡æª”
docs: check-poetry
	@echo "ğŸ“š ç”Ÿæˆ API æ–‡æª”..."
	@echo "Swagger UI: http://localhost:8001/docs"
	@echo "ReDoc: http://localhost:8001/redoc"

# æª¢æŸ¥æœå‹™ç‹€æ…‹
status:
	@echo "ğŸ“Š æª¢æŸ¥ç›¸é—œæœå‹™ç‹€æ…‹..."
	@echo ""
	@echo "ğŸ³ Docker æœå‹™:"
	@docker ps --filter "name=platform-" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || echo "âŒ Docker æœªé‹è¡Œ"
	@echo ""
	@echo "ğŸŒ ç¶²è·¯é€£é€šæ€§æ¸¬è©¦:"
	@echo -n "PostgreSQL (5433): "; nc -z localhost 5433 && echo "âœ… é€£é€š" || echo "âŒ ä¸å¯é”"
	@echo -n "Redis (6380): "; nc -z localhost 6380 && echo "âœ… é€£é€š" || echo "âŒ ä¸å¯é”"  
	@echo -n "RabbitMQ (5672): "; nc -z localhost 5672 && echo "âœ… é€£é€š" || echo "âŒ ä¸å¯é”"
	@echo -n "RabbitMQ Management (15672): "; nc -z localhost 15672 && echo "âœ… é€£é€š" || echo "âŒ ä¸å¯é”"

# æ¸…ç†è‡¨æ™‚æ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†è‡¨æ™‚æ–‡ä»¶..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name ".pytest_cache" -exec rm -rf {} +
	find . -type d -name ".mypy_cache" -exec rm -rf {} +
	find . -type f -name ".coverage" -delete
	rm -rf dist/ build/ *.egg-info/
	@echo "âœ… æ¸…ç†å®Œæˆ"

# Poetry ç’°å¢ƒè³‡è¨Š
info: check-poetry
	@echo "ğŸ“‹ Poetry ç’°å¢ƒè³‡è¨Š:"
	poetry env info
	@echo ""
	@echo "ğŸ“¦ å·²å®‰è£å¥—ä»¶:"
	poetry show --tree

# æ›´æ–°ä¾è³´
update: check-poetry
	@echo "â¬†ï¸ æ›´æ–°ä¾è³´å¥—ä»¶..."
	poetry update
	@echo "âœ… ä¾è³´æ›´æ–°å®Œæˆ" 